# プロダクト要求定義書 (Product Requirements Document)

## プロダクト概要

### 名称

**Subly** - Privacy-first PayFi Protocol for Subscriptions on Solana

### プロダクトコンセプト

- **Privacy-first**: 全ての取引データ、ユーザー情報、契約関係をプライバシー技術で保護。事業者はどのユーザーが契約しているか知ることができない
- **Yield-powered Payments**: ユーザーが入金したUSDCをDeFiで運用し、運用益（Yield）でサブスクリプション料金を支払う。元本を減らさずにサービスを利用可能
- **Decentralized Stripe**: ブロックチェーンネイティブな決済インフラ。中央集権的な決済プロバイダーなしで、Web3プロジェクトがサブスクリプション課金を導入可能

### プロダクトビジョン

Sublyは、プライバシーを最優先にしたWeb3ネイティブのサブスクリプション決済プロトコルを提供する。
ユーザーは自分の資金がどこでどのように使われているかをコントロールでき、事業者は顧客のプライバシーを侵害することなくサブスクリプション収益を得られる。
運用益を活用した決済モデルにより、ユーザーは元本を維持しながらサービスを享受でき、DeFiの恩恵を日常の決済に活かす新しいパラダイムを確立する。
最終的には、Stripeのような使いやすさを持ちながら、ブロックチェーンの透明性とプライバシーを両立した決済インフラとなることを目指す。

### 目的

- Web3プロジェクトが簡単にサブスクリプション課金を導入できるようにする
- ユーザーのプライバシーを完全に保護した状態でサブスクリプション契約を可能にする
- DeFi運用益を活用し、ユーザーの元本を減らさない新しい決済モデルを実現する
- 制裁対象者のスクリーニングを行いながら、個人情報を事業者に渡さないコンプライアンス対応を実現する

## ターゲットユーザー

### プライマリーペルソナ 1: 山田健太（32歳、Web3プロジェクト創業者）

- **属性**: NFTマーケットプレイスを運営するスタートアップのCEO
- **技術スタック**: React/Next.js、Solana Web3.js、Anchor Framework
- **現在の課題**:
  - プレミアム会員機能を実装したいが、オンチェーンでのサブスクリプション決済の仕組みがない
  - Stripeなど従来の決済は法定通貨ベースで、クリプトネイティブユーザーには不便
  - ユーザーのウォレットアドレスと支払い情報が紐づくとプライバシー上の問題がある
- **期待する解決策**: SDKを導入するだけで、プライバシーを保護したサブスクリプション機能を実装したい
- **1日のワークフロー**: コード開発 → ユーザーフィードバック確認 → プロダクト改善のサイクル

### プライマリーペルソナ 2: 佐藤美咲（28歳、DeFiパワーユーザー）

- **属性**: フリーランスデザイナー、複数のWeb3サービスを利用
- **技術スタック**: MetaMask、Phantom Wallet、複数のDeFiプロトコル
- **現在の課題**:
  - 複数のサブスクリプションサービスの支払い管理が面倒
  - サブスクリプション料金で元本が減っていくのが気になる
  - どのサービスを契約しているかがオンチェーンで丸見えになるのが嫌
- **期待する解決策**: 一度入金すれば運用益で支払いが行われ、プライバシーも守られる仕組み
- **1日のワークフロー**: デザイン業務 → DeFiポートフォリオ確認 → Web3サービス利用

## 成功指標（デモ段階）

### Protocol A: subly-membership（Devnet）の成功基準

- **プラン管理機能**: 事業者がプランを作成・編集・削除できる
  - 検証方法: ダッシュボードでの操作確認
- **サブスクリプション契約**: ユーザーがプランに契約できる
  - 検証方法: Arcium MPCで暗号化された契約データの生成確認
- **会員証明**: ZK証明の生成・検証が動作する
  - 検証方法: Light Protocolでの証明生成、事業者側での検証成功
- **プライバシー保護**: 事業者が契約者を特定できない
  - 検証方法: 事業者ダッシュボードで「契約数のみ」表示されることを確認

### Protocol B: subly-vault（Mainnet）の成功基準

- **プライベート入金**: Privacy Cash経由でUSDCを入金できる
  - 検証方法: 入金トランザクションがSolana Explorerで金額・送金元が秘匿されていること
- **DeFi運用**: Kamino Lendingへの預け入れ・運用益発生
  - 検証方法: Kaminoポジションの確認、利回りの表示
- **プライベート送金**: 定期送金が実行され、送金元が秘匿される
  - 検証方法: 事業者アドレスへの着金確認、Solana Explorerでの秘匿確認

### デモシナリオ完走基準

1. 事業者がSDKでプランを作成できる
2. ユーザーがサブスクリプション契約を結べる
3. 事業者ダッシュボードで「契約数: N」のみ表示される（誰かは分からない）
4. ユーザーがZK証明で会員限定コンテンツにアクセスできる
5. ユーザーがUSDCをプライベートに入金できる
6. Kaminoで運用され、Yieldが発生する
7. 定期的に事業者へプライベート送金が実行される
8. Solana Explorerで送金元・金額が秘匿されていることを確認できる

## 機能要件

### Protocol A: subly-membership（Devnet）

会員管理とプライバシー保護を担当。Arcium MPC + Light Protocol で実装。

#### A1: サブスクリプションプラン管理（事業者向け）

**ユーザーストーリー**:
サブスクリプション事業者として、顧客向けの課金プランを作成・管理するために、ダッシュボードでプラン設定ができるようにしたい

**受け入れ条件**:

- [ ] 事業者はプラン名、説明、価格（USDC）、課金周期を設定できる
- [ ] 課金周期は時間単位、日次、週次、月次、年次から選択可能
- [ ] カスタム課金周期も設定可能（最小: 1時間、最大: 365日）
- [ ] デモでは1時間周期でテスト
- [ ] 作成したプランは一覧表示され、編集・削除・無効化が可能
- [ ] プランにはユニークな識別子が割り当てられ、SDK経由で参照可能
- [ ] プラン情報はオンチェーンに保存される（Arcium MPC経由）

**優先度**: P0（必須）

#### A2: サブスクリプション契約機能

**ユーザーストーリー**:
サブスクリプションユーザーとして、事業者のサービスを利用するために、プライバシーを保護した状態でサブスクリプション契約を結びたい

**受け入れ条件**:

- [ ] ユーザーはSDK経由で事業者のプランに契約できる
- [ ] 契約情報はArcium MPCで暗号化され、事業者はどのユーザーが契約しているか特定できない
- [ ] 契約時に会員証明用のコミットメントが生成される
- [ ] 契約完了後、ユーザーは自分の契約情報を確認できる
- [ ] 事業者は「契約数」のみ確認可能、個人は特定不可

**優先度**: P0（必須）

#### A2-2: サブスクリプション解約機能

**ユーザーストーリー**:
サブスクリプションユーザーとして、不要になったサービスを解約するために、プライバシーを保護した状態でサブスクリプション契約を解除したい

**受け入れ条件**:

- [ ] ユーザーはSDK経由でサブスクリプションを解約できる
- [ ] 解約時に契約数がデクリメントされる（Arcium MPC内で処理）
- [ ] 解約後、ユーザーのZK証明は無効になる（Merkle Treeから削除またはnullifier登録）
- [ ] 解約しても事業者は「誰が解約したか」を特定できない
- [ ] 解約完了後、ユーザーは自分の契約一覧から該当契約が削除されていることを確認できる
- [ ] Protocol B（Vault）での定期送金設定がある場合、連動してキャンセルするかユーザーに確認する

**優先度**: P1（重要）

#### A3: 会員証明機能（ゼロ知識証明）

**ユーザーストーリー**:
サブスクリプションユーザーとして、個人情報を明かさずにサービスにアクセスするために、ゼロ知識証明で会員であることを証明したい

**受け入れ条件**:

- [ ] ユーザーはLight Protocolを使用してゼロ知識証明を生成できる
- [ ] 証明には「特定のプランの会員である」という情報のみが含まれる
- [ ] 証明にはユーザーのウォレットアドレスや個人情報は含まれない
- [ ] 事業者は証明を検証して会員かどうかを判定できる
- [ ] 証明はアクセス時に毎回生成・検証する（有効期限なし）

**優先度**: P0（必須）

#### A4: 事業者向けSDK（Node.js）

**ユーザーストーリー**:
サブスクリプション事業者として、自社アプリにサブスクリプション機能を組み込むために、使いやすいSDKが欲しい

**受け入れ条件**:

- [ ] npm経由でインストール可能（`@subly/membership-sdk`）
- [ ] TypeScript型定義が含まれる
- [ ] 以下のAPIが提供される:
  - `getPlans()`: サブスクリプションプラン一覧の取得
  - `createSubscription()`: 契約フローの開始
  - `verifyMembership()`: 会員証明の検証
  - `getSubscriptionCount()`: アクティブ契約数の取得
- [ ] React/Next.jsでの使用例がドキュメントに含まれる
- [ ] エラーハンドリングが適切に実装されている

**優先度**: P0（必須）

#### A5: 事業者ダッシュボード

**ユーザーストーリー**:
サブスクリプション事業者として、サブスクリプションビジネスの状況を把握するために、管理ダッシュボードが欲しい

**受け入れ条件**:

- [ ] 事業者はウォレット接続でログインできる
- [ ] サブスクリプションプランの作成・編集・削除ができる
- [ ] アクティブなサブスクリプション数を確認できる（個人は特定できない）
- [ ] プラン別の契約数を確認できる
- [ ] SDK統合用のAPIキー・設定情報を取得できる

**優先度**: P0（必須）

#### A6: 制裁チェック機能

**ユーザーストーリー**:
プロトコル運営者として、制裁対象者の利用を防止するために、契約時にアドレスチェックを行いたい

**受け入れ条件**:

- [ ] Range Risk APIを使用してアドレスのリスクスコアを取得
- [ ] 制裁対象アドレスからの契約をブロックする
- [ ] チェック結果はユーザーのプライバシーを保護した形で処理される（結果のみ保存、詳細は破棄）
- [ ] 制裁チェックの結果は事業者には共有されない
- [ ] Switchboard Oracleを使用したオンチェーン検証（オプション）

**優先度**: P1（重要）

#### A7: 多層プライバシー保護（MagicBlock PER統合）

**ユーザーストーリー**:
プライバシーを重視するユーザーとして、暗号化されたデータだけでなく、そのデータの存在自体も隠蔽したい。第三者がオンチェーンでPDAの存在を確認できないようにしたい

**受け入れ条件**:

- [ ] 会員データを格納するPDAをMagicBlock PERに委譲（delegate）できる
- [ ] 委譲されたPDAはTEE（Intel TDX）内でのみアクセス可能
- [ ] Permission Programによりアカウント単位のアクセス制御を実装
- [ ] 許可されたユーザー（本人、検証者）のみがPDAにアクセス可能
- [ ] Arciumの暗号化と組み合わせた多層防御が機能する
- [ ] プライベートRPC経由での操作が可能

**技術的背景**:

```
┌─────────────────────────────────────────────────────┐
│ 第1層: MagicBlock PER (アクセス制御)                │
│   - PDAへのアクセス自体を制限                       │
│   - 許可されたユーザーのみがPDAの存在を認識         │
├─────────────────────────────────────────────────────┤
│ 第2層: Arcium MPC (データ暗号化)                    │
│   - アクセスできてもデータは復号不可                │
│   - 暗号化された状態で計算可能                      │
└─────────────────────────────────────────────────────┘
```

**優先度**: P1（重要 - 多層防御のオプション機能）

---

### Protocol B: subly-vault（Mainnet）

資金運用とプライベート決済を担当。Privacy Cash + Kamino Lending で実装。

#### B1: プライベートUSDC入金機能

**ユーザーストーリー**:
サブスクリプションユーザーとして、USDCを入金してサブスクリプション料金の支払い原資を確保するために、プライバシーを保護した入金機能が欲しい

**受け入れ条件**:

- [ ] ユーザーはUSDCを入金できる（デモでは10 USDCでテスト）
- [ ] 入金はPrivacy Cashの`depositSPL()`を使用してプライベートに処理される
- [ ] 入金後、ユーザーのプライベート残高が更新される
- [ ] 入金トランザクションは第三者から金額・送金元が見えない
- [ ] 入金完了後、ユーザーはダッシュボードで残高を確認できる

**優先度**: P0（必須）

#### B2: DeFi運用機能（Kamino Lending統合）

**ユーザーストーリー**:
サブスクリプションユーザーとして、入金した資金を運用して利回りを得るために、DeFiプロトコルでの自動運用機能が欲しい

**受け入れ条件**:

- [ ] Vault全体の資金をKamino Lendingに預け入れる（プール方式）
- [ ] 個別ユーザーとレンディングポジションは紐付かない
- [ ] 発生した運用益はVault全体で管理し、ユーザーの残高比率で按分
- [ ] ユーザーはダッシュボードで運用状況と利回りを確認できる
- [ ] 出金・決済時は必要額がKaminoから引き出される

**優先度**: P0（必須）

#### B3: プライベート定期送金機能

**ユーザーストーリー**:
サブスクリプションユーザーとして、手動で支払いをしなくても、設定した周期で自動的にプライベートに料金が支払われてほしい

**受け入れ条件**:

- [ ] 課金周期ごとに自動的に決済処理が実行される（Clockwork等のオートメーション使用）
- [ ] 決済はユーザーの運用益（Yield）から優先的に行われる
- [ ] 運用益が不足する場合は元本から補填される
- [ ] 送金はPrivacy Cashの`withdrawSPL()`を使用してプライベートに処理される
- [ ] 決済完了後、事業者のウォレットにUSDCが送金される（送金元は秘匿）
- [ ] Solana Explorerで送金元・金額が見えないことを確認可能

**優先度**: P0（必須）

#### B4: ユーザーダッシュボード（Vault）

**ユーザーストーリー**:
サブスクリプションユーザーとして、自分の資金状況を管理するために、ダッシュボードが欲しい

**受け入れ条件**:

- [ ] ユーザーはウォレット接続でログインできる
- [ ] プライベート残高を確認できる（本人のみ閲覧可能）
- [ ] 運用益の累計・現在の利回りを確認できる
- [ ] 決済履歴を確認できる（日時、金額、送金先は秘匿表示）
- [ ] 資金の追加入金ができる
- [ ] 資金の出金ができる（Privacy Cash経由でプライベートに）

**優先度**: P0（必須）

---

### 将来的な機能（Post-MVP / 統合後）

#### F1: 統合プロトコル

Arcium Mainnetローンチ後、Protocol AとProtocol Bを統合。

- 会員契約と決済の連携
- 単一のユーザー体験として提供
- 完全なプライバシー保護サブスクリプション

**優先度**: P1（重要）

#### F2: オンオフランプ統合

法定通貨からUSDCへの変換、USDCから法定通貨への変換を統合。
MoonPay、Rampなどのサービスとの連携を検討。

**優先度**: P2（できれば）

#### F3: マルチトークン対応

USDC以外のステーブルコイン（USDT、PAYPALUSDなど）のサポート。
Privacy CashがUSDT対応済みのため、比較的容易に拡張可能。

**優先度**: P2（できれば）

## 非機能要件（デモ段階）

### パフォーマンス

- トランザクション処理時間: 30秒以内（Solana確定含む）
- ダッシュボードのページ読み込み: 3秒以内

### ユーザビリティ

- ユーザーが入金からサブスクリプション契約まで完了: 5分以内
- 審査員がドキュメントを見ながら主要操作を完了できる

### 信頼性

- 審査員10人程度が同時に触ってもエラーが出ない
- デモシナリオを完走できる安定性

### セキュリティ

- 全てのユーザーデータはArcium MPCで暗号化
- ゼロ知識証明による会員認証
- 秘密鍵はユーザーのウォレット（Phantom等）で管理
- 外部監査は実施しない（デモ段階のため）

### スケーラビリティ

- 同時接続ユーザー数: 10人程度
- 1日あたりのトランザクション数: 100件程度

## スコープ外

明示的にスコープ外とする項目:

- 法定通貨での直接決済（オンオフランプ経由での対応のみ）
- USDC以外のトークンでの決済（MVPでは）
- モバイルアプリ（Webアプリのみ）
- KYC/AML（制裁チェックのみ実施）
- NFTベースの会員証（ゼロ知識証明での対応）
- Solana以外のブロックチェーン対応

## プロトコル構成

Sublyは技術的制約（Arcium: Devnetのみ、DeFi/Privacy Cash: Mainnetのみ）により、2つの独立したプロトコルとして実装し、将来的に統合する。

### Protocol A/B間の連携（デモ段階）

デモ段階では、Protocol AとProtocol Bは独立して動作し、ユーザーが手動で管理する：

- **Protocol A（会員管理）**: ユーザーが契約したプランIDを記録
- **Protocol B（決済）**: ユーザーが事業者アドレスと金額を手動で設定して定期送金
- **紐付け**: ユーザーが自身で「どのプランに対していくら支払うか」を管理

```
[デモ段階の連携フロー]
1. ユーザーがProtocol Aでプランに契約（プランID取得）
2. ユーザーがProtocol BでUSDCを入金
3. ユーザーがProtocol Bで定期送金を設定（事業者アドレス、金額、周期）
4. 定期送金が自動実行
5. サービス利用時、Protocol AでZK証明を生成・検証
```

### Protocol A: subly-membership（Devnet）

会員管理とプライバシー保護を担当するプロトコル。

**技術スタック**:

- Arcium MPC: 会員データの暗号化、契約情報の秘匿
- Light Protocol: ゼロ知識証明による会員証明

**機能**:

- サブスクリプションプラン管理（事業者）
- サブスクリプション契約（ユーザー）
- ZK会員証明の生成・検証
- 事業者ダッシュボード（契約数のみ表示、個人特定不可）

**デモシナリオ**:

1. 事業者がSDKでプラン作成
2. ユーザーがサブスク契約
3. 事業者ダッシュボードで「契約数: 5」のみ表示、誰かは分からない
4. ユーザーがZK証明で会員限定コンテンツにアクセス

### Protocol B: subly-vault（Mainnet）

資金運用とプライベート決済を担当するプロトコル。

**技術スタック**:

- Privacy Cash: プライベート入金・送金（USDC対応）
- Kamino Lending: DeFi運用（Yield生成）

**機能**:

- プライベートUSDC入金
- Kamino Lendingでの自動運用
- 定期的なプライベート送金（事業者への支払い）
- ユーザーダッシュボード（残高・運用状況）

**デモシナリオ**:

1. ユーザーがUSDCをプライベートに入金
2. Kaminoで運用、Yieldが発生
3. 定期的に事業者アドレスへプライベート送金
4. Solana Explorerで送金元・送金先・金額が秘匿されていることを確認

### 将来的な統合（Arcium Mainnet後）

Arcium Mainnetローンチ後、2つのプロトコルを統合:

- Protocol A の会員データと Protocol B の決済を連携
- 完全なプライバシー保護サブスクリプションを実現
- 単一のユーザー体験として提供

```
[統合後のアーキテクチャ]

┌─────────────────────────────────────────────────────────────┐
│                    Subly Protocol (Mainnet)                  │
├─────────────────────────────────────────────────────────────┤
│  Arcium MPC Layer                                            │
│  - 会員データ暗号化 / サブスク契約 / ZK証明                   │
├─────────────────────────────────────────────────────────────┤
│  Privacy Cash / C-SPL                                        │
│  - プライベート送金（金額・送金先を秘匿）                     │
├─────────────────────────────────────────────────────────────┤
│  DeFi Integration                                            │
│  - Kamino Lending（プライバシー保護付き運用）                │
└─────────────────────────────────────────────────────────────┘
```

## 技術的前提条件と制約

### Arcium（Devnetのみ）

- 現在Devnetのみで利用可能
- Mainnet Alpha: Q4 2025予定
- C-SPL（Confidential SPL Token Standard）も提供予定

### Privacy Cash（Mainnet）

- Mainnetで稼働中（2025年8月ローンチ）
- USDC、USDT、SOLに対応
- TypeScript SDK、Rust SDKが利用可能
- 複数の監査済み（Accretion、HashCloak、Zigtur、Kriko）

### Kamino Lending（Mainnet）

- Mainnetでのみ有効な利回りを提供
- USDC Lendingで年率約5-10%の利回り

### Light Protocol

- Devnet、Mainnet両方で利用可能
- ZK Compressionによる低コストなZK証明

## 参考リンク

- [Arcium Arcis Framework](https://docs.arcium.com/developers/arcis)
- [Arcium Roadmap](https://www.arcium.com/articles/arcium-roadmap-update)
- [Light Protocol / ZK Compression](https://www.zkcompression.com/)
- [MagicBlock Private Ephemeral Rollups](https://docs.magicblock.gg/pages/private-ephemeral-rollups-pers/how-to-guide/quickstart)
- [MagicBlock Privacy on Solana](https://www.magicblock.xyz/solana-privacy)
- [Privacy Cash](https://privacycash.mintlify.app/)
- [Privacy Cash SDK (Rust)](https://docs.rs/privacy-cash-sdk/latest/privacy_cash/)
- [Privacy Cash SDK (npm)](https://libraries.io/npm/privacycash)
- [Range Risk API](https://docs.range.org/risk-api/risk-introduction)
- [Kamino Finance SDK](https://docs.kamino.finance/build-on-kamino/sdk-and-smart-contracts)
- [Confidential Balances (Token-2022)](https://www.solana-program.com/docs/confidential-balances)
