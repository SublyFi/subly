# 技術仕様書 (Architecture Design Document)

## 概要

本ドキュメントはSublyの技術仕様を定義する。SublyはSolanaブロックチェーン上に構築されるプライバシーファーストのサブスクリプション決済プロトコルであり、2つの独立したプロトコルで構成される。

- **Protocol A: subly-membership** - 会員管理とプライバシー保護（Solana Devnet）
- **Protocol B: subly-vault** - 資金運用とプライベート決済（Solana Mainnet）

## テクノロジースタック

### 言語・ランタイム

| 技術       | バージョン | 選定理由                                                                 |
| ---------- | ---------- | ------------------------------------------------------------------------ |
| Rust       | 1.93+      | Solanaプログラム開発の標準言語。メモリ安全性と高パフォーマンスを両立     |
| TypeScript | 5.x        | フロントエンド・SDK開発に使用。静的型付けによりバグを早期発見            |
| Node.js    | 24.x LTS   | SDK・ダッシュボードのランタイム。長期サポートと安定性を重視              |
| pnpm       | 10.x       | 高速で効率的なパッケージマネージャー。workspaces対応でモノレポ管理に最適 |

### Solanaプログラム開発

| 技術           | バージョン | 用途                           | 選定理由                                                                   |
| -------------- | ---------- | ------------------------------ | -------------------------------------------------------------------------- |
| Anchor         | 0.32.x     | Solanaプログラムフレームワーク | 宣言的なアカウント検証、IDL生成によるSDK自動生成、Solanaエコシステムの標準 |
| Solana CLI     | 3.x        | 開発・デプロイツール           | Solana開発の公式ツールチェーン                                             |
| solana-program | 3.x        | オンチェーンプログラム基盤     | Solana公式のプログラムライブラリ                                           |

### プライバシー技術

| 技術           | 用途                               | 選定理由                                                             |
| -------------- | ---------------------------------- | -------------------------------------------------------------------- |
| Arcium MPC     | 暗号化データ処理（Protocol A）     | 秘密分散によるマルチパーティ計算。暗号化状態のまま契約数の集計が可能 |
| Light Protocol | ゼロ知識証明（Protocol A, B）      | ZK Compressionによる低コストなZK証明。Solana統合が成熟               |
| Privacy Cash   | プライベート送金（Protocol B）     | 監査済みのプライベートトランザクション。USDC対応、Mainnet稼働中      |
| ECIES          | クライアント側暗号化（Protocol B） | 楕円曲線ベースの暗号化。ウォレット署名から鍵導出可能                 |

### DeFi統合

| 技術           | 用途           | 選定理由                                                      |
| -------------- | -------------- | ------------------------------------------------------------- |
| Kamino Lending | USDC運用       | Solana最大のレンディングプロトコル。安定した年率5-10%の利回り |
| Clockwork      | 定期送金自動化 | Solanaネイティブのタスクスケジューラー。ガスレス実行対応      |

### 外部サービス

| 技術           | 用途                       | 選定理由                                                    |
| -------------- | -------------------------- | ----------------------------------------------------------- |
| Range Risk API | 制裁チェック               | ウォレットアドレスのリスクスコア取得。コンプライアンス対応  |
| MagicBlock PER | アクセス制御（オプション） | TEE（Intel TDX）によるPDAアクセス制御。多層プライバシー保護 |

### フロントエンド・SDK

| 技術                   | バージョン | 用途                                 | 選定理由                                                   |
| ---------------------- | ---------- | ------------------------------------ | ---------------------------------------------------------- |
| Next.js                | 16.x       | ダッシュボードUI                     | React Server Components対応、高速なビルド                  |
| React                  | 19.x       | UIライブラリ                         | Solanaウォレットアダプター互換                             |
| TailwindCSS            | 4.x        | スタイリング                         | 統一されたデザインシステムを効率的に構築                   |
| @solana/kit            | 最新       | Solana RPC/トランザクション（推奨）  | 新しいSolana公式ライブラリ。Protocol B、ダッシュボードで使用 |
| @solana/web3.js        | 2.x        | Solana接続（Arciumクライアントのみ） | Arciumとの互換性維持のためProtocol Aで使用                 |
| @solana/wallet-adapter | 最新       | ウォレット接続                       | Phantom, Backpack等の主要ウォレット対応                    |
| @coral-xyz/anchor      | 0.32.x     | Anchor SDK                           | IDLからTypeScript型を自動生成                              |

### 開発ツール

| 技術     | バージョン | 用途                     | 選定理由                         |
| -------- | ---------- | ------------------------ | -------------------------------- |
| Vitest   | 3.x        | ユニットテスト           | 高速な実行、TypeScript対応       |
| Bankrun  | 最新       | Solanaプログラムテスト   | ローカル環境でのプログラムテスト |
| ESLint   | 9.x        | 静的解析                 | コード品質の維持                 |
| Prettier | 3.x        | コードフォーマット       | 一貫したコードスタイル           |
| Biome    | 最新       | Rustフォーマット・リント | Rust開発の標準ツール             |

## アーキテクチャパターン

### システム全体構成

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           User Layer                                     │
├─────────────────────────────────────────────────────────────────────────┤
│  Phantom/Backpack Wallet  │  Business Dashboard  │  User Dashboard       │
└─────────────────────────────────────────────────────────────────────────┘
                    │                  │                    │
                    ▼                  ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            SDK Layer                                     │
├─────────────────────────────────────────────────────────────────────────┤
│         @subly/membership-sdk         │       @subly/vault-sdk           │
└─────────────────────────────────────────────────────────────────────────┘
                    │                                       │
        ┌───────────┴───────────┐               ┌──────────┴──────────┐
        ▼                       ▼               ▼                      ▼
┌───────────────────────────────────┐   ┌───────────────────────────────────┐
│   Protocol A: subly-membership    │   │     Protocol B: subly-vault       │
│          (Solana Devnet)          │   │        (Solana Mainnet)           │
├───────────────────────────────────┤   ├───────────────────────────────────┤
│  ┌─────────────────────────────┐  │   │  ┌─────────────────────────────┐  │
│  │    Anchor Program           │  │   │  │    Anchor Program           │  │
│  │    - Plan Management        │  │   │  │    - Shield Pool            │  │
│  │    - Subscription           │  │   │  │    - Share Management       │  │
│  │    - Membership Proof       │  │   │  │    - Scheduled Transfer     │  │
│  └─────────────────────────────┘  │   │  └─────────────────────────────┘  │
│              │                    │   │              │                    │
│  ┌───────────┴───────────┐        │   │  ┌───────────┴───────────┐        │
│  ▼                       ▼        │   │  ▼                       ▼        │
│  ┌─────────────┐ ┌─────────────┐  │   │  ┌─────────────┐ ┌─────────────┐  │
│  │ Arcium MPC  │ │    Light    │  │   │  │  Privacy    │ │   Kamino    │  │
│  │ (Encryption)│ │  Protocol   │  │   │  │    Cash     │ │  Lending    │  │
│  │             │ │ (ZK Proofs) │  │   │  │ (Transfer)  │ │  (Yield)    │  │
│  └─────────────┘ └─────────────┘  │   │  └─────────────┘ └─────────────┘  │
└───────────────────────────────────┘   └───────────────────────────────────┘
```

### レイヤードアーキテクチャ

各プロトコルは以下のレイヤー構造を持つ:

```
┌─────────────────────────────────────┐
│      プレゼンテーション層            │ ← ダッシュボード UI
├─────────────────────────────────────┤
│           SDK層                      │ ← TypeScript SDK
├─────────────────────────────────────┤
│     オンチェーンプログラム層          │ ← Anchor Programs
├─────────────────────────────────────┤
│       プライバシー層                 │ ← Arcium / Light / Privacy Cash
├─────────────────────────────────────┤
│        インフラ層                    │ ← Solana Blockchain
└─────────────────────────────────────┘
```

#### プレゼンテーション層

- **責務**: ユーザーインターフェースの提供、入力バリデーション、結果の表示
- **技術**: Next.js、React、TailwindCSS
- **許可される操作**: SDK層の呼び出しのみ
- **禁止される操作**: オンチェーンプログラムへの直接アクセス

#### SDK層

- **責務**: ビジネスロジックのカプセル化、トランザクション構築、暗号化処理
- **技術**: TypeScript、@coral-xyz/anchor
- **許可される操作**: オンチェーンプログラムとの通信、暗号化・ZK証明生成
- **禁止される操作**: UI依存のコード

#### オンチェーンプログラム層

- **責務**: 状態管理、アクセス制御、検証ロジック
- **技術**: Rust、Anchor Framework
- **許可される操作**: PDA操作、CPI（Cross-Program Invocation）
- **禁止される操作**: 外部API呼び出し（オラクル経由を除く）

#### プライバシー層

- **責務**: 暗号化、ゼロ知識証明、プライベート送金
- **技術**: Arcium MPC、Light Protocol、Privacy Cash
- **許可される操作**: 暗号化データの処理、証明の生成・検証

#### インフラ層

- **責務**: トランザクションの実行、状態の永続化
- **技術**: Solana Blockchain（Devnet / Mainnet）

## データ永続化戦略

### オンチェーンストレージ

| データ種別         | ストレージ | 暗号化                                   | 理由                               |
| ------------------ | ---------- | ---------------------------------------- | ---------------------------------- |
| プラン情報         | Solana PDA | 一部（名称・説明は平文、契約数は暗号化） | 公開情報と秘匿情報の分離           |
| サブスクリプション | Solana PDA | 暗号化（Arcium MPC）                     | ユーザー特定を防止                 |
| ユーザーシェア     | Solana PDA | 暗号化（ECIES）                          | シェア量の秘匿化                   |
| 送金設定           | Solana PDA | 部分暗号化                               | 事業者アドレスは公開（受取のため） |
| ZK証明nullifier    | Solana PDA | なし                                     | 二重使用防止用のハッシュ           |

### オフチェーンストレージ

| データ種別     | ストレージ                      | フォーマット | 理由                       |
| -------------- | ------------------------------- | ------------ | -------------------------- |
| ユーザー秘密値 | ローカル（ブラウザ/ウォレット） | 暗号化JSON   | ユーザーのみがアクセス可能 |
| 一時的なZK証明 | メモリ                          | バイナリ     | 使い捨て、永続化不要       |
| SDK設定        | 環境変数                        | 平文         | APIキー等の機密情報        |

### バックアップ戦略

オンチェーンデータはSolanaブロックチェーンにより自動的に複製・保持される。
ユーザーの秘密値（secret）は以下の方法でバックアップを推奨:

- **方法1**: ウォレット署名から再導出可能な設計（推奨）
- **方法2**: 暗号化してユーザーがエクスポート
- **復元**: ウォレット接続 + 署名で秘密値を再生成

## パフォーマンス要件

### レスポンスタイム

| 操作                             | 目標時間 | 測定環境                   |
| -------------------------------- | -------- | -------------------------- |
| ページ読み込み（ダッシュボード） | 3秒以内  | 標準的なブロードバンド環境 |
| トランザクション送信             | 5秒以内  | Solana RPC応答含む         |
| トランザクション確定             | 30秒以内 | Solanaファイナリティ含む   |
| ZK証明生成（クライアント）       | 10秒以内 | M1 Mac相当のCPU            |
| Arcium MPC計算                   | 20秒以内 | MXEクラスター処理含む      |

### リソース使用量

| リソース           | 上限         | 理由                         |
| ------------------ | ------------ | ---------------------------- |
| ブラウザメモリ     | 512MB        | ZK証明生成時のピーク使用量   |
| SDK バンドルサイズ | 500KB (gzip) | 初期ロード時間を抑制         |
| PDAサイズ（最大）  | 10KB         | Solanaアカウントサイズ制限内 |

### スケーラビリティ目標

| 指標                         | デモ段階 | 本番想定  |
| ---------------------------- | -------- | --------- |
| 同時接続ユーザー             | 10人     | 1,000人   |
| 1日のトランザクション        | 100件    | 10,000件  |
| アクティブサブスクリプション | 100件    | 100,000件 |

## セキュリティアーキテクチャ

### プライバシー保護の多層防御

```
┌─────────────────────────────────────────────────────────────────────────┐
│ Layer 1: MagicBlock PER（オプション）                                    │
│   - PDAへのアクセス自体を制限                                            │
│   - TEE（Intel TDX）内でのみデータにアクセス可能                          │
├─────────────────────────────────────────────────────────────────────────┤
│ Layer 2: Arcium MPC / ECIES暗号化                                       │
│   - データは暗号化された状態でオンチェーン保存                            │
│   - 復号には正当な権限が必要                                             │
├─────────────────────────────────────────────────────────────────────────┤
│ Layer 3: コミットメントベースの識別                                       │
│   - ウォレットアドレスを直接保存しない                                    │
│   - hash(secret || identifier)で紐付け                                   │
├─────────────────────────────────────────────────────────────────────────┤
│ Layer 4: Privacy Cash送金                                               │
│   - 送金元・金額を秘匿                                                   │
│   - 第三者から追跡不可能                                                 │
└─────────────────────────────────────────────────────────────────────────┘
```

### 暗号化方式

| 用途                   | 方式                               | 鍵管理                  |
| ---------------------- | ---------------------------------- | ----------------------- |
| Protocol A: 契約データ | Arcium MPC (X25519 + RescueCipher) | MXEクラスターで秘密分散 |
| Protocol B: シェア量   | ECIES (secp256k1)                  | ウォレット署名から導出  |
| 通信                   | TLS 1.3                            | 標準的なHTTPS           |

### 入力検証

- **SDK側**: Zodによるスキーマ検証
- **オンチェーン**: Anchor制約 (`constraint`, `require!`)
- **サニタイゼーション**: 文字列長制限、特殊文字エスケープ

### 脅威モデルと対策

| 脅威                 | 対策                                         |
| -------------------- | -------------------------------------------- |
| ウォレットハッキング | ハードウェアウォレット推奨、秘密値の分離保管 |
| MEV攻撃              | Privacy Cashによる送金秘匿化                 |
| フロントランニング   | Arciumによる暗号化、コミットメント方式       |
| 制裁対象者の利用     | Range Risk APIによるアドレスチェック         |
| 二重使用             | Nullifierによる使用済み証明の追跡            |

## スケーラビリティ設計

### Protocol A（会員管理）

- **データ増加対応**: プランごとのPDA分離、契約数のみカウント（個別契約PDAは最小限）
- **アーカイブ**: 解約済みサブスクリプションは一定期間後に圧縮

### Protocol B（資金運用）

- **シールドプール方式**: 個別ユーザーとKaminoポジションのリンクを断絶
- **バッチ処理**: 定期送金のClockwork一括実行
- **ZK証明バッチ**: 複数送金の証明を事前生成してオンチェーン保存

### 機能拡張性

- **マルチトークン**: Privacy CashのUSDT対応により容易に拡張
- **新規DeFi統合**: Shield Poolアーキテクチャで他のレンディングプロトコルにも対応可能
- **オラクル統合**: Switchboardによるオンチェーン制裁チェックへの拡張

## テスト戦略

### ユニットテスト

- **フレームワーク**: Vitest (TypeScript), cargo test (Rust)
- **対象**: SDK関数、暗号化処理、データ変換
- **カバレッジ目標**: 80%以上
- **実行コマンド**:
  - TypeScript: `pnpm test`
  - Rust: `cargo test`

### 統合テスト

- **方法**: Bankrunによるローカルテスト、Arcium/Anchorテストフレームワーク
- **対象**: Anchor命令の実行、CPI、PDA操作、Arcium MPC処理
- **シナリオ**: プラン作成→契約→証明生成→検証の一連フロー
- **実行コマンド**:
  - Protocol A (Arcium統合): `arcium test`
  - Protocol B (Anchor): `anchor test`

### E2Eテスト

- **ツール**: Playwright (ダッシュボード), カスタムスクリプト (SDK)
- **対象**: ウォレット接続→入金→契約→送金の完全フロー
- **環境**: Devnet (Protocol A), Mainnet-fork (Protocol B)

### セキュリティテスト

- **静的解析**: Clippy (Rust), ESLint security plugins
- **監査**: 本番リリース前に外部監査を予定（デモ段階では実施しない）

## 技術的制約

### Arcium（Protocol A）

- **ネットワーク**: Devnetのみ（Mainnet Alphaは遅延中、本プロジェクトはDevnetでのデモを目標とする）
- **計算コスト**: MXE計算に追加レイテンシ（5-15秒）
- **データサイズ**: 暗号文のオーバーヘッド（+16-32バイト）

### Privacy Cash（Protocol B）

- **ネットワーク**: Mainnetのみ
- **対応トークン**: USDC, USDT, SOL
- **送金レイテンシ**: 通常のSolanaトランザクションより長い

### Light Protocol

- **証明サイズ**: 数百バイト（Solanaトランザクションサイズ制限内）
- **生成時間**: クライアント側で5-10秒
- **検証コスト**: 標準的なCPI呼び出し程度

### Solana

- **トランザクションサイズ**: 1232バイト
- **アカウントサイズ**: 10MB（実用上は数KB）
- **CU制限**: 1,400,000 compute units/トランザクション

## 依存関係管理

### Solanaプログラム (Cargo.toml)

| ライブラリ     | 用途           | バージョン管理方針               |
| -------------- | -------------- | -------------------------------- |
| anchor-lang    | フレームワーク | マイナーバージョン固定 (=0.32.x) |
| arcium-anchor  | Arcium統合     | 最新追従                         |
| light-sdk      | ZK証明         | 最新追従                         |
| solana-program | 基盤           | Anchorに追従                     |

### SDK・フロントエンド (package.json)

| ライブラリ        | 用途                                   | バージョン管理方針      |
| ----------------- | -------------------------------------- | ----------------------- |
| @solana/kit       | Solana接続（推奨、Protocol B等）       | 最新追従                |
| @solana/web3.js   | Solana接続（Arciumクライアントのみ）   | ^2.0.0（メジャー固定）  |
| @coral-xyz/anchor | Anchor SDK                             | ^0.32.0（マイナー許可） |
| next              | フレームワーク                         | ^16.0.0（メジャー固定） |
| react             | UI                                     | ^19.0.0（メジャー固定） |
| typescript        | 言語                                   | ~5.7.0（パッチのみ許可）|

**Solanaクライアントライブラリの使い分け:**

- **@solana/kit**: 新しい推奨ライブラリ。Protocol B（subly-vault）やダッシュボード等で使用
- **@solana/web3.js**: Arciumクライアントとの互換性が必要な場合のみ使用（Protocol A）

### 依存関係更新方針

- **セキュリティパッチ**: 即時適用
- **マイナーアップデート**: 週次でテスト後適用
- **メジャーアップデート**: 四半期ごとに評価・計画的に適用

## 環境要件

### 開発環境

- **OS**: macOS 14+, Ubuntu 24.04+, Windows 11 (WSL2)
- **Rust**: 1.93+
- **Node.js**: 24.x LTS
- **Solana CLI**: 3.x
- **Anchor CLI**: 0.32.x

### 本番環境

- **RPC**: Helius, QuickNode等の商用RPC推奨
- **フロントエンド**: Vercel, Cloudflare Pages
- **監視**: 標準的なWeb監視ツール

## 参考リンク

- [Anchor Framework](https://www.anchor-lang.com/)
- [Arcium Documentation](https://docs.arcium.com/)
- [Light Protocol / ZK Compression](https://www.zkcompression.com/)
- [Privacy Cash](https://privacycash.mintlify.app/)
- [Kamino Finance](https://docs.kamino.finance/)
- [MagicBlock PER](https://docs.magicblock.gg/pages/private-ephemeral-rollups-pers)
- [Range Risk API](https://docs.range.org/risk-api)
- [Clockwork](https://docs.clockwork.xyz/)
