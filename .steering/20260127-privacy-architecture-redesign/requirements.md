# 要求内容: プライバシーアーキテクチャ再設計

## 概要

subly-vaultのプライバシー保護が不完全であることが判明したため、Privacy Cash必須化とアーキテクチャの根本的な再設計を行う。

## 背景

### 現在の問題点

現在の実装では、以下のプライバシー問題が存在する:

#### 1. 入金時のプライバシー欠如
- **問題**: オンチェーンプログラムで `depositor` が署名者として記録される
- **影響**: 誰がいくら入金したかがオンチェーンで公開される
- **現状**: Privacy Cashはオプション機能（デフォルト未使用）

#### 2. 定期送金時のプライバシー欠如
- **問題**: `ScheduledTransfer` PDAに `recipient`（事業者アドレス）が平文で保存される
- **影響**: オンチェーンでユーザーがどの事業者に送金しているかが判明可能
- **現状**: Privacy Cash経由の送金がオンチェーンに統合されていない

#### 3. ユーザー・事業者の紐付け可能
- **問題**: `user_commitment` と `recipient` が同じPDAに保存されている
- **影響**: オンチェーンデータ分析でユーザーと事業者の関係が特定可能
- **現状**: commitment から署名者への逆引きも可能

### 期待される状態

| 項目 | 現状 | 目標 |
|------|------|------|
| 入金元の秘匿 | 公開 | **プライベート** |
| 入金額の秘匿 | 公開 | **プライベート** |
| 送金先の秘匿 | 公開 | **プライベート** |
| ユーザー・事業者紐付け | 可能 | **不可能** |

## 実装対象の変更

### 1. Privacy Cash 必須化

**入金フロー変更**:
- ユーザーは直接Shield Poolに入金しない
- 全ての入金はPrivacy Cash経由で行う
- オンチェーンプログラムでは「Privacy Cashからの匿名入金」のみを受け付ける

**出金・送金フロー変更**:
- 全ての出金・定期送金はPrivacy Cash経由で実行
- オンチェーンでは送金先を暗号化、または保存しない

### 2. アーキテクチャ再設計

**ScheduledTransfer の変更**:
- `recipient` フィールドを削除、または暗号化
- 送金先情報はオフチェーン（ユーザーのローカル）で管理
- 実行時にクライアントが送金先を提供（ZK証明で正当性を検証）

**入金証明の変更**:
- Privacy Cashの入金証明（note commitment）をShield Poolに登録
- ユーザーのウォレットアドレスを一切オンチェーンに保存しない

### 3. 新しいデータフロー

```
【プライベート入金フロー】
1. ユーザー → Privacy Cash depositSPL() → プライベート残高
2. Privacy Cash → withdrawSPL(Shield Pool) → Shield Pool受領
3. Shield Pool: note commitmentのみ記録（送金元不明）
4. ユーザー: オフチェーンでシェア量を計算・保持

【プライベート定期送金フロー】
1. ユーザー: オフチェーンで送金情報を暗号化保持
2. 実行時: クライアントがPrivacy Cash withdrawSPL(recipient)を呼び出し
3. Shield Pool: 残高減少のみ記録（送金先不明）
4. 事業者: Privacy Cash経由で受領（送金元不明）
```

## 受け入れ条件

### Privacy Cash 必須化
- [ ] 全ての入金がPrivacy Cash `depositSPL()` 経由で行われる
- [ ] 全ての出金がPrivacy Cash `withdrawSPL()` 経由で行われる
- [ ] SDK から直接入金オプション（`usePrivacyCash: false`）を削除
- [ ] オンチェーンプログラムで `depositor` の署名を不要にする

### 送金先の秘匿化
- [ ] `ScheduledTransfer` から `recipient` フィールドを削除
- [ ] 送金先情報はユーザーのローカルストレージで暗号化保持
- [ ] 実行時にクライアントが送金先を提供する方式に変更

### ユーザー識別の秘匿化
- [ ] オンチェーンに `depositor` のウォレットアドレスを保存しない
- [ ] `user_commitment` のみでユーザーを識別（コミットメントからアドレス逆引き不可）
- [ ] トランザクション署名者と残高保有者を分離

### オンチェーン検証
- [ ] Privacy Cash の note commitment を検証する仕組みを追加
- [ ] 送金実行時の正当性検証（ZK証明 or 署名）

## 技術的制約

### Privacy Cash
- Mainnetのみサポート（Devnetなし）
- Node.js 24以上が必要
- 手数料: 出金時 0.35% + 0.006 SOL

### 設計上の制約
- オンチェーンプログラムからPrivacy CashへのCPIは不可能（SDK経由のみ）
- 送金実行はクライアント（またはTuk Tuk + リレーヤー）が実行

## スコープ外

以下はこのフェーズでは実装しない:

- 完全なZKプルーフ検証（プレースホルダー実装）
- MagicBlock PER統合（多層防御オプション）
- Devnet対応（Privacy CashがMainnetのみのため）

## 成功指標

1. **入金の匿名性**: Solana Explorer で入金トランザクションを確認しても、送金元・金額が不明
2. **送金の匿名性**: 定期送金の実行トランザクションを確認しても、送金先が不明
3. **紐付け不可**: オンチェーンデータからユーザーと事業者の関係を特定できない

## 参照ドキュメント

- [Privacy Cash SDK Docs](https://privacycash.mintlify.app/sdk/overview)
- `docs/architecture.md` - アーキテクチャ設計書
- `.steering/20260127-mainnet-phase2/tasklist.md` - 前回の実装タスク
