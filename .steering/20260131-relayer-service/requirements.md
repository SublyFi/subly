# 要求定義: Relayer Service

## 概要

ShieldPoolのプライバシー保護設計を実現するため、専用のリレイヤーサービスを実装する。
現状ではユーザー自身が`registerDeposit`の署名者（registrar）となっており、オンチェーンにユーザーのウォレットアドレスが記録されてしまう問題を解決する。

## 背景・課題

### 現状の問題

```
現在の実装:
  ユーザー ─── registerDeposit() を自分で署名
                    ↓
  オンチェーンに registrar = ユーザーアドレス が記録される
                    ↓
  ユーザーと入金の紐付けが可能 → プライバシー崩壊
```

### 設計意図との乖離

| 項目 | 設計意図 | 現状 |
|------|---------|------|
| `registrar`の署名者 | 第三者リレイヤー | ユーザー本人 |
| オンチェーン記録 | ユーザーアドレスなし | ユーザーアドレスが記録される |
| プライバシー | 入金者特定不可 | 入金者が特定可能 |

## 機能要件

### FR-1: リレイヤーAPIエンドポイント

- ユーザーからのdeposit登録リクエストを受け付ける
- リレイヤーのウォレットで`registerDeposit`トランザクションを実行
- ユーザーのウォレットアドレスを受け取らない・記録しない

### FR-2: リクエスト検証

- Privacy Cashからの入金証明（noteCommitment）の検証
- Shield Pool ATAの残高確認
- リプレイ攻撃防止（同じnoteCommitmentの二重登録防止）

### FR-3: トランザクション実行

- リレイヤーウォレットで署名・送信
- トランザクション結果の返却
- エラーハンドリング・リトライ

### FR-4: 手数料管理

- リレイヤーがSOL手数料を負担
- ユーザーからの手数料徴収方法の検討（オプション）

## 非機能要件

### NFR-1: セキュリティ

- リレイヤーの秘密鍵を安全に管理
- 不正なリクエストの拒否
- レート制限

### NFR-2: 可用性

- リレイヤーがダウンしても既存のシェアには影響なし
- バックアップリレイヤーの検討

### NFR-3: プライバシー

- ユーザーIPアドレスのログを残さない（または匿名化）
- リクエスト内容からユーザーを特定できないようにする

## 受け入れ条件

- [ ] ユーザーが`registerDeposit`に署名せずに入金登録できる
- [ ] オンチェーンの`registrar`がリレイヤーアドレスになっている
- [ ] ユーザーのウォレットアドレスがオンチェーンに記録されない
- [ ] Privacy Cashからの入金証明が正しく検証される
