# 要求内容

## 概要

Protocol B: subly-vault（Mainnet）の初回実装。プライベート入金・出金、DeFi運用（Kamino Lending）、定期送金機能を持つVaultプログラムを構築する。

## 背景

SublyはDevnet（Protocol A: 会員管理）とMainnet（Protocol B: Vault）の2つのプロトコルで構成される。本タスクではMainnet向けのProtocol Bを初回実装し、以下を実現する：

- ユーザーがUSDCをプライベートに入金できる
- 入金した資金をKamino Lendingで運用し、利回り（Yield）を得られる
- 定期的に事業者へプライベート送金を実行できる
- Solana Explorerで送金元・金額が秘匿されていることを確認できる

## 実装対象の機能

### 1. B1: プライベートUSDC入金機能

- Privacy Cashの`depositSPL()`を使用してUSDCをプライベートに入金
- 入金後、ユーザーのプライベート残高が更新される
- 入金トランザクションは第三者から金額・送金元が見えない
- ユーザーはダッシュボードで残高を確認できる

### 2. B2: DeFi運用機能（Kamino Lending統合）

- Vault全体の資金をKamino Lendingに預け入れる（プール方式）
- 個別ユーザーとレンディングポジションは紐付かない
- 発生した運用益はVault全体で管理し、ユーザーの残高比率で按分
- ユーザーはダッシュボードで運用状況と利回りを確認できる

### 3. B3: プライベート定期送金機能

- 課金周期ごとに自動的に決済処理が実行される（Clockwork等のオートメーション使用）
- 決済はユーザーの運用益（Yield）から優先的に行われる
- 運用益が不足する場合は元本から補填される
- 送金はPrivacy Cashの`withdrawSPL()`を使用してプライベートに処理される

### 4. B4: 出金機能

- ユーザーはプライベート残高から出金できる
- Privacy Cash経由でプライベートに出金処理
- 定期送金設定がある場合は残高チェックを行う

## 受け入れ条件

### B1: プライベートUSDC入金機能

- [ ] ユーザーはUSDCを入金できる（デモでは10 USDCでテスト）
- [ ] 入金はPrivacy Cashの`depositSPL()`を使用してプライベートに処理される
- [ ] 入金後、ユーザーのプライベート残高が更新される
- [ ] 入金トランザクションは第三者から金額・送金元が見えない

### B2: DeFi運用機能（Kamino Lending統合）

- [ ] Vault全体の資金をKamino Lendingに預け入れる
- [ ] 個別ユーザーとレンディングポジションは紐付かない
- [ ] 発生した運用益はVault全体で管理し、ユーザーの残高比率で按分
- [ ] 出金・決済時は必要額がKaminoから引き出される

### B3: プライベート定期送金機能

- [ ] 課金周期ごとに自動的に決済処理が実行される
- [ ] 決済はユーザーの運用益（Yield）から優先的に行われる
- [ ] 運用益が不足する場合は元本から補填される
- [ ] 送金はPrivacy Cashを使用してプライベートに処理される
- [ ] 決済完了後、事業者のウォレットにUSDCが送金される（送金元は秘匿）

### B4: 出金機能

- [ ] ユーザーはプライベート残高から出金できる
- [ ] 出金はPrivacy Cash経由でプライベートに処理される

## 成功指標

- トランザクション処理時間: 30秒以内（Solana確定含む）
- 同時接続ユーザー: 10人程度が問題なく操作できる
- Solana Explorerで送金元・金額が秘匿されていることを確認できる

## スコープ外

以下はこのフェーズでは実装しません：

- Protocol A（subly-membership）との連携
- ユーザーダッシュボードUI（別途実装）
- マルチトークン対応（USDC以外）
- オンオフランプ統合
- 外部監査対応

## 技術的制約

### Privacy Cash

- **ネットワーク**: Mainnetのみで動作
- **対応トークン**: USDC, USDT, SOL
- **送金レイテンシ**: 通常のSolanaトランザクションより長い

### Kamino Lending

- **ネットワーク**: Mainnetでのみ有効な利回りを提供
- **USDC Lending**: 年率約5-10%の利回り

### 開発環境

初期開発・テストはlocalnetで行い、検証後にMainnetにデプロイ予定。

## 参照ドキュメント

- `docs/product-requirements.md` - プロダクト要求定義書
- `docs/functional-design.md` - 機能設計書
- `docs/architecture.md` - アーキテクチャ設計書
- `docs/repository-structure.md` - リポジトリ構造定義書
- `docs/development-guidelines.md` - 開発ガイドライン
