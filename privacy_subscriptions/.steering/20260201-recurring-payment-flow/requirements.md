# 要求内容

## 概要

定期支払い処理（process_payment）を自動的にトリガーするための仕組みを実装します。Tuk Tuk によるオンチェーン自動化と、手動トリガー用のスクリプト両方に対応します。

## 背景

現在の実装では `process_payment` インストラクションは完成していますが、これを定期的に実行するトリガーの仕組みがありません。MVP フェーズでは以下の 2 つのアプローチで定期支払いを実現します:

1. **Tuk Tuk 統合**: Helium 開発のオンチェーン自動化エンジンを使用した完全自動化
2. **手動トリガースクリプト**: 管理者やバッチジョブから process_payment を呼び出すスクリプト

## 実装対象の機能

### 1. Tuk Tuk 統合（オンチェーン自動化）

- Task Queue の初期化インストラクション
- サブスクリプション登録時に最初の支払いタスクをスケジュール
- process_payment 実行後に次回支払いタスクを自己再キューイング
- Task Queue 管理用インストラクション（資金追加、クローズなど）

### 2. 手動トリガースクリプト

- 全アクティブサブスクリプションを取得
- 支払い期日が到来したサブスクリプションをフィルタリング
- process_payment インストラクションを順次呼び出し
- 実行結果のログ出力

### 3. SDK 拡張

- Tuk Tuk Task Queue のセットアップ関数
- 手動トリガー用のバッチ処理関数
- サブスクリプション一覧取得の強化

## 受け入れ条件

### Tuk Tuk 統合

- [ ] Task Queue を初期化できる
- [ ] サブスクリプション登録時に初回支払いタスクがスケジュールされる
- [ ] process_payment 実行後、次回支払いタスクが自動でキューに追加される
- [ ] Task Queue に資金を追加できる
- [ ] Task Queue をクローズして残高を回収できる

### 手動トリガースクリプト

- [ ] TypeScript スクリプトで全アクティブサブスクリプションを取得できる
- [ ] 支払い期日が到来したサブスクリプションを特定できる
- [ ] process_payment を順次呼び出して支払い処理できる
- [ ] 実行結果（成功/失敗）がログに出力される

### SDK 拡張

- [ ] `setupTaskQueue()` 関数で Task Queue を初期化できる
- [ ] `triggerPayments()` 関数で手動バッチ処理ができる
- [ ] `getSubscriptionsDue()` 関数で支払い期日のサブスクリプションを取得できる

## 成功指標

- 定期支払いが自動または手動で確実に実行される
- 支払い漏れがない（期日到来したサブスクリプションは全て処理される）
- エラー発生時に適切にログ出力され、問題特定が可能

## スコープ外

以下はこのフェーズでは実装しません:

- Tuk Tuk Cron ジョブ（CLI でのバッチスケジュール）: 自己再キューイング方式で対応
- プロトコル手数料の自動徴収ロジック: MVP では手数料 0% のため不要
- 複数トークンの同時バッチ処理: 単一トークン（SOL or 特定 SPL）に限定
- Web UI からのトリガー機能: SDK/スクリプト経由のみ

## 制約事項

- Tuk Tuk Task Queue には最低 1 SOL のデポジットが必要（Devnet では Devnet SOL を使用）
- process_payment は Arcium MPC 計算を伴うため、1 件あたり数秒のレイテンシが発生
- 手動トリガースクリプトは管理者の秘密鍵が必要（payer として署名）

## 参照ドキュメント

- `docs/product-requirements.md` - プロダクト要求定義書
- `docs/functional-design.md` - 機能設計書（8. Clockwork Cron 設計）
- `docs/architecture.md` - アーキテクチャ設計書
- `.steering/20250131-initial-implementation/tasklist.md` - 初回実装タスクリスト
