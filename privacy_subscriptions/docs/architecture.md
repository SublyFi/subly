# 技術仕様書 (Architecture Design Document)

## 1. テクノロジースタック

### 1.1 オンチェーン（Solana Program）

| 技術   | バージョン | 選定理由                                                                                       |
| ------ | ---------- | ---------------------------------------------------------------------------------------------- |
| Rust   | 1.79+      | Solana プログラム開発の標準言語。メモリ安全性と高いパフォーマンスを提供                        |
| Anchor | 0.32.1     | Solana プログラム開発フレームワーク。PDA 管理、アカウント検証、シリアライゼーションを簡素化    |
| Arcium | 0.6.3      | MPC（Multi-Party Computation）ベースのプライバシー保護機能を提供。暗号化データの計算をサポート |
| Arcis  | 0.6.3      | Arcium の MPC 回路記述言語。暗号化された値に対する算術・論理演算を定義                         |

### 1.2 オフチェーン（SDK/Client）

| 技術              | バージョン | 選定理由                                                              |
| ----------------- | ---------- | --------------------------------------------------------------------- |
| TypeScript        | 5.x        | 静的型付けにより開発効率と保守性が向上。SDK 利用者に型情報を提供      |
| @solana/web3.js   | 1.x        | Solana ブロックチェーンとの通信、トランザクション構築・送信           |
| @coral-xyz/anchor | 0.32.1     | Anchor プログラムとの連携に必要。IDL ベースの型安全なクライアント生成 |
| @arcium-hq/client | 0.6.3      | Arcium MPC クラスターとの通信、暗号化・復号化処理を提供               |

### 1.3 フロントエンド

| 技術    | バージョン | 選定理由                                                                 |
| ------- | ---------- | ------------------------------------------------------------------------ |
| Next.js | 14.x       | React ベースのフルスタックフレームワーク。SSR/SSG 対応、App Router 採用 |
| React   | 18.x       | コンポーネントベース UI ライブラリ。エコシステムが豊富                   |
| Node.js | 24.13.0    | JavaScript ランタイム。LTS 版を使用                                      |

### 1.5 開発ツール

| ツール     | バージョン | 用途                                               |
| ---------- | ---------- | -------------------------------------------------- |
| Solana CLI | 1.18+      | ローカルバリデータ、デプロイ、トランザクション送信 |
| Anchor CLI | 0.32.1     | プログラムビルド、テスト、IDL 生成                 |
| Arcium CLI | 0.6.3      | MXE セットアップ、暗号化回路のコンパイル・デプロイ |
| ts-mocha   | 10.x       | TypeScript テストランナー                          |
| Prettier   | 2.x        | コードフォーマッター                               |

### 1.6 テストツール

| ツール       | 用途                                                |
| ------------ | --------------------------------------------------- |
| Anchor Test  | ローカルバリデータでの統合テスト（Arcium MXE 含む） |
| Mocha + Chai | TypeScript テストフレームワーク                     |

## 2. システムアーキテクチャ

### 2.1 全体構成

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Subly Architecture                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐    │
│  │   User Wallet    │     │  Merchant App    │     │  Subly Dashboard │    │
│  │   (Phantom等)    │     │  (SDK組込)       │     │  (事業者向け)    │    │
│  └────────┬─────────┘     └────────┬─────────┘     └────────┬─────────┘    │
│           │                        │                        │               │
│           └────────────────────────┼────────────────────────┘               │
│                                    │                                         │
│                          ┌─────────▼─────────┐                              │
│                          │     Subly SDK     │                              │
│                          │   (TypeScript)    │                              │
│                          └─────────┬─────────┘                              │
│                                    │                                         │
│  ┌─────────────────────────────────┼─────────────────────────────────────┐  │
│  │                         Solana Blockchain                              │  │
│  │  ┌──────────────────────────────▼──────────────────────────────────┐  │  │
│  │  │                    Subly Anchor Program                          │  │  │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │  │  │
│  │  │  │ Non-Encrypt │  │  Encrypted  │  │   Arcis Circuits        │  │  │  │
│  │  │  │ Instructions│  │ Instructions│  │   (MPC処理定義)         │  │  │  │
│  │  │  └─────────────┘  └──────┬──────┘  └─────────────────────────┘  │  │  │
│  │  └──────────────────────────┼──────────────────────────────────────┘  │  │
│  │                             │                                          │  │
│  │  ┌──────────────────────────▼──────────────────────────────────────┐  │  │
│  │  │                      Arcium Program                              │  │  │
│  │  │         (Queue Computation / Callback Handler)                   │  │  │
│  │  └──────────────────────────┬──────────────────────────────────────┘  │  │
│  └─────────────────────────────┼──────────────────────────────────────────┘  │
│                                │                                             │
│                      ┌─────────▼─────────┐                                  │
│                      │   Arcium MPC      │                                  │
│                      │   Cluster         │                                  │
│                      │ (MXE Nodes)       │                                  │
│                      └───────────────────┘                                  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         Clockwork / Cron                               │  │
│  │                    (自動支払い処理トリガー)                            │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 レイヤードアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                    プレゼンテーション層                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ User Dashboard  │  │Merchant Dashboard│ │  Merchant App   │ │
│  │   (Next.js)     │  │    (Next.js)     │ │   (SDK組込)     │ │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘ │
└───────────┼─────────────────────┼─────────────────────┼─────────┘
            │                     │                     │
┌───────────▼─────────────────────▼─────────────────────▼─────────┐
│                        SDK層 (Subly SDK)                         │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ - トランザクション構築                                     │  │
│  │ - 暗号化/復号化処理                                        │  │
│  │ - Arcium クライアント連携                                  │  │
│  │ - アカウント状態取得                                       │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
┌─────────────────────────────────▼───────────────────────────────┐
│                    ビジネスロジック層 (On-chain)                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │           Subly Anchor Program                             │  │
│  │  ┌─────────────────────┐  ┌─────────────────────────────┐ │  │
│  │  │ 非暗号化処理         │  │ 暗号化処理 (3フェーズ)      │ │  │
│  │  │ - initialize_protocol│  │ - deposit (init/queue/cb)  │ │  │
│  │  │ - register_merchant  │  │ - withdraw (init/queue/cb) │ │  │
│  │  │ - create_plan        │  │ - subscribe (init/queue/cb)│ │  │
│  │  │ - update_plan        │  │ - unsubscribe              │ │  │
│  │  └─────────────────────┘  │ - process_payment          │ │  │
│  │                           │ - verify_subscription      │ │  │
│  │                           │ - claim_revenue            │ │  │
│  │                           └─────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
┌─────────────────────────────────▼───────────────────────────────┐
│                      MPC計算層 (Arcium)                          │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │           Arcium MPC Cluster (MXE Nodes)                   │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ Arcis Circuits (encrypted-ixs)                       │  │  │
│  │  │ - deposit_circuit: 残高加算                          │  │  │
│  │  │ - withdraw_circuit: 残高減算 + 検証                  │  │  │
│  │  │ - subscribe_circuit: サブスク登録 + 初回支払い       │  │  │
│  │  │ - process_payment_circuit: 定期支払い処理            │  │  │
│  │  │ - verify_subscription_circuit: 有効性検証            │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
┌─────────────────────────────────▼───────────────────────────────┐
│                      データ永続化層 (Solana)                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    PDA Accounts                            │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐│  │
│  │  │ProtocolPool │  │ UserLedger  │  │ MerchantLedger      ││  │
│  │  │(実トークン) │  │ (暗号化残高)│  │ (暗号化残高)        ││  │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘│  │
│  │  ┌─────────────┐  ┌─────────────────────────────────────┐ │  │
│  │  │Subscription │  │ UserSubscription (暗号化状態)        │ │  │
│  │  │    Plan     │  │                                      │ │  │
│  │  └─────────────┘  └─────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 コンポーネント責務

| コンポーネント       | 責務                                                       |
| -------------------- | ---------------------------------------------------------- |
| User Dashboard       | ユーザー向け UI（Deposit/Withdraw/サブスク管理）           |
| Merchant Dashboard   | 事業者向け UI（プラン管理/収益確認/Claim）                 |
| Subly SDK            | クライアントライブラリ（トランザクション構築、暗号化処理） |
| Subly Anchor Program | オンチェーンロジック、アカウント管理、Arcium 連携          |
| Arcis Circuits       | MPC 回路定義（暗号化データの計算ロジック）                 |
| Arcium MPC Cluster   | 秘密分散による暗号化データの計算実行                       |
| Clockwork            | 定期支払い処理の自動実行トリガー                           |

## 3. Arcium 統合アーキテクチャ

### 3.1 暗号化処理の 3 フェーズパターン

Arcium では、暗号化データを扱う各処理に対して 3 つのフェーズが必要です。

```
┌─────────────────────────────────────────────────────────────────┐
│  Arcium 3-Phase Pattern                                         │
├─────────────────────────────────────────────────────────────────┤
│  1. Init (初期化)     - 暗号化処理の定義をセットアップ          │
│                        （デプロイ時1回のみ実行）                │
│                                                                  │
│  2. Queue (キュー)    - 暗号化データを受け取り、                │
│                         MPC クラスターに計算をキュー             │
│                                                                  │
│  3. Callback          - MPC 計算完了後、結果を検証・保存        │
│                         （Arciumから非同期で呼び出し）          │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 暗号化データ型

| 型               | 説明                                | 使用場面                 |
| ---------------- | ----------------------------------- | ------------------------ |
| `Enc<Shared, T>` | クライアントと MXE の両者が復号可能 | クライアントからの入力値 |
| `Enc<Mxe, T>`    | MXE のみが復号可能                  | オンチェーン保存用       |
| `.to_arcis()`    | 暗号化データを秘密分散値に変換      | MPC 計算の入力           |
| `.from_arcis()`  | 秘密分散値を暗号化データに変換      | MPC 計算の出力           |
| `.reveal()`      | 秘密分散値を平文化                  | 公開してよい値のみ       |

### 3.3 処理フロー

```
Client                    Subly Program              Arcium/MPC Cluster
   │                          │                          │
   │ ── Encrypt params ──────>│                          │
   │                          │ ── Queue Computation ───>│
   │                          │                          │ (MPC処理)
   │                          │<── Callback with result ─│
   │<── Verify & Store ───────│                          │
```

## 4. データ永続化戦略

### 4.1 ストレージ方式

| データ種別     | ストレージ | フォーマット | 理由                                             |
| -------------- | ---------- | ------------ | ------------------------------------------------ |
| アカウント状態 | Solana PDA | Borsh        | オンチェーンでの永続化、PDA による安全なアクセス |
| 暗号化残高     | Solana PDA | バイト配列   | Arcium による暗号化データの保存                  |
| トークン残高   | SPL Token  | -            | 共通プールでの実トークン管理                     |

### 4.2 PDA（Program Derived Address）設計

| アカウント         | Seeds                                      | 説明                         |
| ------------------ | ------------------------------------------ | ---------------------------- |
| `ProtocolConfig`   | `["protocol_config"]`                      | プロトコル設定               |
| `ProtocolPool`     | `["protocol_pool", mint]`                  | トークン種別ごとの共通プール |
| `Merchant`         | `["merchant", wallet]`                     | 事業者情報                   |
| `MerchantLedger`   | `["merchant_ledger", merchant, mint]`      | 事業者帳簿残高               |
| `SubscriptionPlan` | `["subscription_plan", merchant, plan_id]` | サブスクプラン               |
| `UserLedger`       | `["user_ledger", user, mint]`              | ユーザー帳簿残高             |
| `UserSubscription` | `["user_subscription", user, sub_index]`   | サブスク状態                 |

### 4.3 バックアップ戦略

- **オンチェーンデータ**: Solana の分散ネットワークにより自動的に冗長化
- **暗号化データ**: Arcium MPC クラスターによる秘密分散で保護
- **クライアントキー**: ユーザーのウォレットで管理（自己管理型）

## 5. パフォーマンス要件

### 5.1 レスポンスタイム

| 操作                       | 目標時間 | 備考                                      |
| -------------------------- | -------- | ----------------------------------------- |
| 非暗号化インストラクション | < 500ms  | register_merchant, create_plan など       |
| 暗号化インストラクション   | < 5s     | MPC 計算を含む（deposit, subscribe など） |
| サブスク状態確認           | < 2s     | verify_subscription（MPC 計算含む）       |

### 5.2 スループット

| 指標                   | 目標値                        |
| ---------------------- | ----------------------------- |
| 支払い処理スループット | 100 件/分 以上                |
| Cron ジョブ実行時間    | 1 日あたり 100 件を 30 分以内 |

### 5.3 リソース使用量

| リソース         | 制約                                     |
| ---------------- | ---------------------------------------- |
| Compute Units    | 1 トランザクションあたり 200,000 CU 以内 |
| アカウントサイズ | 各 PDA 10KB 以内                         |
| 同時接続ユーザー | 100 人以上対応                           |

## 6. セキュリティアーキテクチャ

### 6.1 データ保護

| 保護対象     | 方式              | 説明                           |
| ------------ | ----------------- | ------------------------------ |
| ユーザー残高 | Arcium MPC 暗号化 | 本人のみ復号可能               |
| 事業者残高   | Arcium MPC 暗号化 | 本人のみ復号可能               |
| サブスク状態 | Arcium MPC 暗号化 | プラン・ステータスすべて暗号化 |
| 支払い履歴   | 帳簿パターン      | 実送金なしでプライバシー保護   |

### 6.2 アクセス制御

```
┌─────────────────────────────────────────────────────────────────┐
│  アクセス制御マトリクス                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ユーザー:                                                       │
│    ├── 自分の UserLedger       → 読み書き可能（暗号化）         │
│    ├── 自分の UserSubscription → 読み書き可能（暗号化）         │
│    └── 他者のアカウント        → アクセス不可                   │
│                                                                  │
│  事業者:                                                         │
│    ├── 自分の Merchant         → 読み書き可能                   │
│    ├── 自分の MerchantLedger   → 読み書き可能（暗号化）         │
│    ├── 自分の SubscriptionPlan → 読み書き可能                   │
│    └── ユーザー情報            → アクセス不可                   │
│                                                                  │
│  プロトコル管理者:                                               │
│    ├── ProtocolConfig          → 読み書き可能                   │
│    └── 他のアカウント          → 読み取りのみ（暗号化データ）   │
│                                                                  │
│  第三者:                                                         │
│    └── 全アカウント            → 暗号化データのみ閲覧可能       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.3 署名検証

| 検証項目             | 方式                             |
| -------------------- | -------------------------------- |
| トランザクション署名 | Solana 標準（Ed25519）           |
| MPC 計算結果署名     | Arcium クラスター署名            |
| Callback 検証        | `verify_output()` による署名検証 |

### 6.4 入力検証

```rust
// 例: プラン作成時の検証
pub fn create_subscription_plan(
    ctx: Context<CreateSubscriptionPlan>,
    name: String,
    price: u64,
    billing_cycle_days: u32,
) -> Result<()> {
    // 名前の長さ検証
    require!(name.len() <= 32, ErrorCode::NameTooLong);

    // 価格の検証（0 は許可しない）
    require!(price > 0, ErrorCode::InvalidPrice);

    // 請求サイクルの検証（1日以上365日以内）
    require!(
        billing_cycle_days >= 1 && billing_cycle_days <= 365,
        ErrorCode::InvalidBillingCycle
    );

    // ...
}
```

## 7. スケーラビリティ設計

### 7.1 データ増加への対応

| 想定規模        | 対策                                |
| --------------- | ----------------------------------- |
| ユーザー数 100+ | PDA による分散アカウント管理        |
| サブスク数 100+ | 効率的な PDA シード設計、バッチ処理 |
| 日次支払い 100+ | Clockwork による並列バッチ処理      |

### 7.2 機能拡張性

| 拡張ポイント       | 設計                            |
| ------------------ | ------------------------------- |
| 新トークン対応     | ProtocolPool を mint ごとに作成 |
| 新プラン種別       | SubscriptionPlan の拡張         |
| マルチチェーン対応 | SDK 抽象化層の設計              |

### 7.3 将来の CSPL 対応

```
Phase 1 (MVP): Shared Pool + Ledger パターン + Arcium 暗号化
    └── 現在の実装

Phase 2 (将来): CSPL (Confidential SPL) トークン対応
    └── Confidential Transfer による金額秘匿
    └── 抽象化レイヤーで移行コスト最小化
```

## 8. テスト戦略

### 8.1 ユニットテスト

| 対象               | フレームワーク | カバレッジ目標 |
| ------------------ | -------------- | -------------- |
| Arcis Circuits     | Rust 標準      | 90%+           |
| SDK ユーティリティ | Mocha + Chai   | 80%+           |

### 8.2 統合テスト

| テスト種別     | 環境                                  | 対象                 |
| -------------- | ------------------------------------- | -------------------- |
| ローカルテスト | solana-test-validator + Arcium MXE    | 全インストラクション |
| Devnet テスト  | Solana Devnet + Arcium Devnet Cluster | E2E シナリオ         |

### 8.3 テストシナリオ

```
1. プロトコル初期化
   └── initialize_protocol → ProtocolConfig 作成

2. 事業者フロー
   └── register_merchant → create_plan → claim_revenue

3. ユーザーフロー
   └── deposit → subscribe → (自動支払い) → unsubscribe → withdraw

4. 自動支払いフロー
   └── Clockwork trigger → process_payment → 帳簿更新

5. プライバシー検証
   └── 第三者からのデータ解読不可を確認
```

## 9. 技術的制約

### 9.1 環境要件

| 要件              | 仕様                           |
| ----------------- | ------------------------------ |
| Solana バージョン | 1.18+                          |
| Anchor バージョン | 0.32.1                         |
| Arcium バージョン | 0.6.3                          |
| 対応ネットワーク  | Devnet（MVP）、Mainnet（将来） |

### 9.2 Arcium 依存の制約

| 制約                 | 影響                                  |
| -------------------- | ------------------------------------- |
| MPC クラスター可用性 | クラスターダウン時は暗号化処理不可    |
| 計算レイテンシ       | MPC 計算により 2-5 秒のレイテンシ発生 |
| クラスターコスト     | 計算ごとに ARX トークン消費           |

### 9.3 CSPL 非対応

| 制約                 | 代替策                       |
| -------------------- | ---------------------------- |
| 入出金時の金額公開   | Shared Pool パターンで最小化 |
| トークン転送追跡可能 | 帳簿パターンで実送金を最小化 |

## 10. 依存関係管理

### 10.1 Rust 依存関係

| クレート      | バージョン | 管理方針                       |
| ------------- | ---------- | ------------------------------ |
| anchor-lang   | 0.32.1     | Arcium との互換性のため固定    |
| arcium-anchor | =0.6.3     | 完全固定（破壊的変更のリスク） |
| arcium-client | =0.6.3     | 完全固定                       |
| arcium-macros | =0.6.3     | 完全固定                       |
| arcis         | =0.6.3     | 完全固定                       |

### 10.2 TypeScript 依存関係

| パッケージ        | バージョン | 管理方針                      |
| ----------------- | ---------- | ----------------------------- |
| @coral-xyz/anchor | ^0.32.1    | マイナーバージョンまで許可    |
| @arcium-hq/client | 0.6.3      | 完全固定                      |
| typescript        | ^5.7.3     | メジャーバージョン 5 系で固定 |

### 10.3 バージョンアップ方針

```
1. Arcium 関連: 公式リリースノート確認後、テスト環境で検証してからアップグレード
2. Anchor: Arcium との互換性を確認してからアップグレード
3. その他: セキュリティパッチは即座に適用、機能追加は検証後
```

---

## 変更履歴

| 日付       | バージョン | 変更内容 | 作成者 |
| ---------- | ---------- | -------- | ------ |
| 2025-01-31 | 1.0        | 初版作成 | -      |
