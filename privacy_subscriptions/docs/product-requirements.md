# プロダクト要求定義書 (Product Requirements Document)

## 1. プロダクトビジョンと目的

### 1.1 ビジョン

**Subly** は、Arcium の MPC（Multi-Party Computation）技術を活用した **プライバシー保護型サブスクリプション基盤** です。Web3 版の Private Stripe として、サブスクリプション状態・支払い情報・ユーザー関係性を完全に暗号化したまま管理します。

### 1.2 目的

- サブスクリプション契約者の匿名性を保証する
- 支払い金額・支払い先を第三者から秘匿する
- 事業者に対しても「誰が契約しているか」を非公開にできる
- オンチェーンで自動的な定期支払いを実現する

### 1.3 プロダクトコンセプト

> "Where access control is about objects, subscriptions are about relationships."

アクセス制御がオブジェクトに関するものであるのに対し、サブスクリプションは関係性に関するものです。Subly はサブスクリプション状態をオンチェーンで暗号化し、Arcium が「誰がサブスクライブしているか」「どのティアか」「支払いは有効か」を秘密裏に管理します。

## 2. ターゲットユーザーと課題・ニーズ

### 2.1 ターゲットユーザー

#### プライマリユーザー: 事業者（Merchant）

- DeFi プロトコル運営者
- NFT/コンテンツクリエイター
- SaaS プロバイダー
- DAO 運営者

#### セカンダリユーザー: エンドユーザー（Subscriber）

- プライバシーを重視する Web3 ユーザー
- 複数のサービスにサブスクライブしているユーザー
- 自動支払いを希望するユーザー

### 2.2 課題

| ユーザー | 課題                                                                    |
| -------- | ----------------------------------------------------------------------- |
| 事業者   | オンチェーンでサブスクリプション管理すると全ての契約情報が公開される    |
| 事業者   | 定期支払いの自動化が困難                                                |
| ユーザー | どのサービスに課金しているか第三者に知られる                            |
| ユーザー | ウォレットアドレスから支払い履歴が追跡可能                              |
| 両者     | CSPL（Confidential SPL）トークンが未成熟で Confidential Transfer が困難 |

### 2.3 ニーズ

- **事業者**: 簡単に導入できる SDK、ダッシュボードでのプラン管理、自動集金
- **ユーザー**: ワンクリックでのサブスク登録/解除、残高の自動引き落とし、プライバシー保証

## 3. 主要な機能一覧

### 3.1 コア機能

| #   | 機能名                     | 説明                                                                    |
| --- | -------------------------- | ----------------------------------------------------------------------- |
| 1   | **Pool Deposit**           | ユーザーが SOL/SPL トークンを共通 Pool にデポジット（残高は帳簿で管理） |
| 2   | **Subscription Plan 管理** | 事業者がプランと料金を登録・管理（ダッシュボード経由）                  |
| 3   | **Subscription 登録/解除** | ユーザーが SDK 経由でサブスクリプションを開始/停止                      |
| 4   | **Subscription 状態照会**  | WalletConnect 時に暗号化された状態から有効性を判定                      |
| 5   | **自動支払い処理**         | Cron ジョブで毎日支払い処理を実行、帳簿上の残高を更新（実送金なし）     |
| 6   | **自動解約処理**           | 帳簿残高不足時にサブスクリプションを自動解約                            |
| 7   | **事業者 Claim**           | 事業者が帳簿上の収益を共通 Pool から引き出し                            |
| 8   | **User Withdraw**          | ユーザーが帳簿上の残高を共通 Pool から引き出し                          |

### 3.2 サポート機能

| #   | 機能名              | 説明                                               |
| --- | ------------------- | -------------------------------------------------- |
| 9   | **Subly Dashboard** | 事業者向けの Web ダッシュボード                    |
| 10  | **Subly SDK**       | 事業者アプリ組み込み用の JavaScript/TypeScript SDK |
| 11  | **Onchain Cron**    | Clockwork 等を利用した自動実行トリガー             |

## 4. 成功の定義

### 4.1 主要成功指標（KPI）

| 指標                           | 目標値                     |
| ------------------------------ | -------------------------- |
| SDK 導入事業者数               | MVP 後 6 ヶ月で 10+        |
| アクティブサブスクリプション数 | MVP 後 6 ヶ月で 1,000+     |
| 平均支払い成功率               | 95%以上                    |
| ガス代最適化                   | 1 支払いあたり < 0.001 SOL |

### 4.2 定性的成功基準

- 事業者がダッシュボードから 5 分以内にプラン登録できる
- ユーザーが 3 クリック以内でサブスクリプション開始できる
- サブスクリプション状態が第三者から解読不可能である

## 5. ビジネス要件

### 5.1 収益モデル

| 収益源           | 説明                                                                                      |
| ---------------- | ----------------------------------------------------------------------------------------- |
| プロトコル手数料 | 各支払いの 1-3%を Subly プロトコルが徴収 ※初期の MVP 時点では手数料は無料で徴収しません。 |

### 5.2 制約事項

- CSPL トークンは現時点で利用不可のため、代替アプローチを採用
  - **代替案 A**: Arcium 暗号化 + 通常 SPL トークンでの Vault 間移動
  - **代替案 B**: 将来的な CSPL 対応を見据えた抽象化レイヤー設計
- Solana Devnet での動作を前提とする
- Arcium MPC クラスターへの依存

## 6. ユーザーストーリー

### 6.1 事業者ストーリー

```
AS A 事業者
I WANT TO Subly ダッシュボードでサブスクリプションプランを登録する
SO THAT 自分のアプリにプライバシー保護型サブスクを導入できる
```

```
AS A 事業者
I WANT TO Subly SDK を自分のアプリに組み込む
SO THAT ユーザーがアプリ内からサブスク登録できる
```

```
AS A 事業者
I WANT TO 蓄積した収益を Vault から引き出す
SO THAT ビジネスの資金として利用できる
```

### 6.2 ユーザーストーリー

```
AS A ユーザー
I WANT TO Vault に資金をデポジットする
SO THAT サブスクリプション料金を自動で支払える
```

```
AS A ユーザー
I WANT TO 事業者アプリからサブスクリプションに登録する
SO THAT プレミアム機能を利用できる
```

```
AS A ユーザー
I WANT TO サブスクリプションを解除する
SO THAT 不要な課金を停止できる
```

```
AS A ユーザー
I WANT TO 自分のサブスク状態を第三者に知られない
SO THAT プライバシーを保護できる
```

## 7. 受け入れ条件

### 7.1 Pool Deposit / Withdraw

- [ ] ユーザーが SOL または SPL トークンを共通 Pool にデポジットできる
- [ ] デポジット金額は帳簿（PDA）に記録される
- [ ] 帳簿上の残高は暗号化されて保存される
- [ ] 帳簿残高を確認できる（本人のみ）
- [ ] ユーザーが帳簿残高の範囲内で共通 Pool から引き出しできる

### 7.2 Subscription Plan 管理

- [ ] 事業者がダッシュボードからプランを作成できる
- [ ] プラン名、料金、請求サイクルを設定できる
- [ ] 複数プラン（ティア）を登録できる
- [ ] プランの有効化/無効化ができる

### 7.3 Subscription 登録/解除

- [ ] ユーザーが SDK 経由でサブスク登録できる
- [ ] サブスク登録時に初回支払いが実行される
- [ ] ユーザーが SDK 経由でサブスク解除できる
- [ ] 解除後は次回請求が発生しない

### 7.4 Subscription 状態照会

- [ ] WalletConnect 時に SDK がサブスク状態を判定できる
- [ ] 有効/無効/期限切れの状態を区別できる
- [ ] 状態は暗号化されており第三者には解読不可

### 7.5 自動支払い処理

- [ ] 毎日 Cron ジョブが実行される
- [ ] 請求日が到来したサブスクに対して支払いが試行される
- [ ] ユーザーの帳簿残高から料金が差し引かれる（実送金なし）
- [ ] 事業者の帳簿残高に収益が加算される
- [ ] 支払い成功時、次回請求日が更新される

### 7.6 自動解約処理

- [ ] 帳簿残高不足時、サブスクリプションが自動解約される

### 7.7 事業者 Claim

- [ ] 事業者が帳簿上の蓄積収益を確認できる
- [ ] 任意のタイミングで共通 Pool から引き出しできる
- [ ] 引き出し時、帳簿残高が減算される
- [ ] 引き出し履歴が記録される

## 8. 機能要件

### 8.1 オンチェーンプログラム（Solana Program）

#### 8.1.1 アカウント構造

**Shared Pool + Ledger パターン**を採用。資金は共通 Pool に集約し、残高は帳簿（PDA）で管理。

```
┌─────────────────────────────────────────────────┐
│  Protocol Pool (実際のトークン保管)              │
│  ┌─────────────────────────────────────────┐   │
│  │  SOL: 10,000 / USDC: 50,000 ...         │   │
│  └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│  Ledger (PDA - 帳簿上の残高)                    │
│  ├── UserLedger[user1] = 100 SOL (暗号化)      │
│  ├── UserLedger[user2] = 50 SOL  (暗号化)      │
│  ├── MerchantLedger[merchant1] = 30 SOL        │
│  ├── MerchantLedger[merchant2] = 20 SOL        │
│  └── ProtocolLedger = 5 SOL (手数料収益)       │
└─────────────────────────────────────────────────┘
```

| アカウント名       | 説明                                     |
| ------------------ | ---------------------------------------- |
| `ProtocolPool`     | 共通資金プール（実際のトークン保管）     |
| `UserLedger`       | ユーザーの帳簿残高（暗号化）             |
| `MerchantLedger`   | 事業者の帳簿残高 （暗号化）              |
| `ProtocolLedger`   | プロトコル手数料の帳簿残高 （暗号化）    |
| `SubscriptionPlan` | 事業者が登録したプラン情報               |
| `UserSubscription` | ユーザーのサブスク状態（暗号化）         |
| `ProtocolConfig`   | プロトコル設定（手数料率など）（暗号化） |

#### 8.1.2 インストラクション（非暗号化処理）

| インストラクション名       | 説明                              |
| -------------------------- | --------------------------------- |
| `initialize_protocol`      | プロトコル初期化（Pool 作成含む） |
| `register_merchant`        | 事業者登録（MerchantLedger 作成） |
| `create_subscription_plan` | プラン作成                        |
| `update_subscription_plan` | プラン更新                        |

### 8.2 暗号化インストラクション（Arcium Encrypted IX）

Arcium では暗号化処理に **3 フェーズパターン** を使用します。各暗号化処理に対して以下の 3 つのインストラクションが必要です。

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Arcium 3-Phase Pattern                                                 │
├─────────────────────────────────────────────────────────────────────────┤
│  1. Init (初期化)     - 暗号化処理の定義をセットアップ（デプロイ時1回） │
│  2. Queue (キュー)    - 暗号化データを受け取り、MPC クラスタに送信      │
│  3. Callback          - MPC 計算完了後、結果を検証・保存                │
└─────────────────────────────────────────────────────────────────────────┘

【実行フロー】
Client                    MXE Program              Arcium/MPC Cluster
   │                          │                          │
   │ ── Encrypt params ──────>│                          │
   │                          │ ── Queue Computation ───>│
   │                          │                          │ (MPC処理)
   │                          │<── Callback with result ─│
   │<── Verify & Store ───────│                          │
```

#### 8.2.1 暗号化データ型（Arcis）

Arcis（Rust ベースの MPC 回路フレームワーク）で使用する暗号化型：

| 型                | 説明                                           |
| ----------------- | ---------------------------------------------- |
| `Enc<Shared, T>`  | クライアントと MXE の両者が復号可能            |
| `Enc<Mxe, T>`     | MXE のみが復号可能（オンチェーン保存用）       |
| `.to_arcis()`     | 暗号化データを秘密分散値に変換（計算用）       |
| `.from_arcis()`   | 秘密分散値を暗号化データに変換（出力用）       |
| `.reveal()`       | 秘密分散値を平文化（公開してよい値のみ）       |

#### 8.2.2 Deposit（帳簿残高加算）

| Phase    | インストラクション名        | 説明                                         |
| -------- | --------------------------- | -------------------------------------------- |
| Init     | `init_deposit_comp_def`     | Deposit 処理の定義（デプロイ時 1 回）        |
| Queue    | `deposit`                   | 暗号化された金額を受け取り、MPC にキュー     |
| Callback | `deposit_callback`          | UserLedger に暗号化残高を加算・保存          |

#### 8.2.3 Withdraw（帳簿残高減算 + 実送金）

| Phase    | インストラクション名        | 説明                                         |
| -------- | --------------------------- | -------------------------------------------- |
| Init     | `init_withdraw_comp_def`    | Withdraw 処理の定義（デプロイ時 1 回）       |
| Queue    | `withdraw`                  | 引き出し額を検証し、MPC にキュー             |
| Callback | `withdraw_callback`         | UserLedger 減算 + Pool から実送金            |

#### 8.2.4 Subscribe（サブスク開始 + 初回支払い）

| Phase    | インストラクション名        | 説明                                         |
| -------- | --------------------------- | -------------------------------------------- |
| Init     | `init_subscribe_comp_def`   | Subscribe 処理の定義（デプロイ時 1 回）      |
| Queue    | `subscribe`                 | プラン情報を受け取り、MPC にキュー           |
| Callback | `subscribe_callback`        | UserSubscription 作成 + 初回帳簿更新         |

#### 8.2.5 Unsubscribe（サブスク解除）

| Phase    | インストラクション名        | 説明                                         |
| -------- | --------------------------- | -------------------------------------------- |
| Init     | `init_unsubscribe_comp_def` | Unsubscribe 処理の定義（デプロイ時 1 回）    |
| Queue    | `unsubscribe`               | 解除リクエストを MPC にキュー                |
| Callback | `unsubscribe_callback`      | UserSubscription を解約状態に更新            |

#### 8.2.6 ProcessPayment（定期支払い処理）

| Phase    | インストラクション名           | 説明                                      |
| -------- | ------------------------------ | ----------------------------------------- |
| Init     | `init_process_payment_comp_def`| 支払い処理の定義（デプロイ時 1 回）       |
| Queue    | `process_payment`              | 対象サブスクを MPC にキュー（Cron 呼出）  |
| Callback | `process_payment_callback`     | UserLedger 減算 + MerchantLedger 加算     |

#### 8.2.7 VerifySubscription（サブスク有効性検証）

| Phase    | インストラクション名              | 説明                                    |
| -------- | --------------------------------- | --------------------------------------- |
| Init     | `init_verify_subscription_comp_def`| 検証処理の定義（デプロイ時 1 回）      |
| Queue    | `verify_subscription`             | ユーザー・事業者情報を MPC にキュー     |
| Callback | `verify_subscription_callback`    | 有効/無効の結果を返却（平文 or 暗号化） |

#### 8.2.8 ClaimRevenue（事業者収益引き出し）

| Phase    | インストラクション名        | 説明                                         |
| -------- | --------------------------- | -------------------------------------------- |
| Init     | `init_claim_revenue_comp_def`| Claim 処理の定義（デプロイ時 1 回）          |
| Queue    | `claim_revenue`             | 引き出し額を検証し、MPC にキュー             |
| Callback | `claim_revenue_callback`    | MerchantLedger 減算 + Pool から実送金        |

### 8.3 Subly SDK

#### 8.3.1 初期化

```typescript
const subly = new SublySDK({
  merchantWallet: "MERCHANT_WALLET_ADDRESS",
  rpcEndpoint: "https://api.devnet.solana.com",
});
```

#### 8.3.2 主要メソッド

| メソッド                    | 説明                                   |
| --------------------------- | -------------------------------------- |
| `checkSubscription(wallet)` | サブスク状態を確認                     |
| `subscribe(planId)`         | サブスク登録                           |
| `unsubscribe()`             | サブスク解除                           |
| `getPlans()`                | 事業者のプラン一覧取得                 |
| `deposit(amount)`           | 共通 Pool にデポジット（帳簿残高加算） |
| `withdraw(amount)`          | 共通 Pool から引き出し（帳簿残高減算） |
| `getBalance()`              | 帳簿残高取得（本人のみ復号可能）       |

### 8.4 Subly Dashboard

#### 8.4.1 機能一覧

- 事業者登録/ログイン（Wallet 認証）
- プラン CRUD 操作
- 収益ダッシュボード（暗号化された集計）
- Claim 操作
- SDK 設定ガイド

## 9. 非機能要件

### 9.1 パフォーマンス

| 項目                   | 要件                          |
| ---------------------- | ----------------------------- |
| 支払い処理スループット | 100 件/分 以上                |
| API レスポンス時間     | 95 パーセンタイル < 1,000ms   |
| Cron ジョブ実行時間    | 1 日あたり 100 件を 30 分以内 |

### 9.2 セキュリティ

| 項目               | 要件                                        |
| ------------------ | ------------------------------------------- |
| 暗号化アルゴリズム | Arcium MPC による閾値暗号化                 |
| キー管理           | Arcium クラスターによる分散管理             |
| アクセス制御       | 本人（ユーザー/事業者）のみがデータ復号可能 |

### 9.3 可用性

| 項目         | 要件                  |
| ------------ | --------------------- |
| 稼働率       | 99.5%以上             |
| 障害復旧時間 | RTO < 4 時間          |
| データ保全   | Solana の耐久性に依存 |

### 9.4 スケーラビリティ

| 項目             | 要件       |
| ---------------- | ---------- |
| 同時接続ユーザー | 100 人以上 |
| サブスク総数     | 100 件以上 |
| 事業者数         | 10 社以上  |

### 9.5 互換性

| 項目              | 要件                                 |
| ----------------- | ------------------------------------ |
| Solana バージョン | 1.18+                                |
| Anchor バージョン | 0.32+                                |
| ウォレット対応    | Phantom, Solflare, Backpack 等       |
| ブラウザ対応      | Chrome, Firefox, Safari, Edge 最新版 |

## 10. 技術的制約と代替案

### 10.1 CSPL トークン非対応への対応

#### 現状の制約

- CSPL（Confidential SPL）トークンは Token-2022 拡張として開発中だが、まだ本番利用可能ではない
- Confidential Transfer による金額秘匿は現時点で困難

#### 採用する代替アプローチ

**Phase 1（MVP）: Shared Pool + Ledger パターン + Arcium 暗号化**

1. 資金は共通 Pool に集約（Deposit/Withdraw 時のみ実送金）
2. 帳簿残高を Arcium で暗号化（UserLedger）
3. 支払い処理は帳簿更新のみ（実送金なし）→ プライバシー向上 + ガス代削減
4. サブスクリプション状態も Arcium で暗号化

```
【Deposit】
User Wallet → Protocol Pool (実際の送金)
UserLedger[user] += amount (帳簿更新、暗号化)

【支払い処理】(送金なし、帳簿のみ)
UserLedger[user] -= subscription_fee (暗号化)
MerchantLedger[merchant] += subscription_fee - protocol_fee
ProtocolLedger += protocol_fee

【Claim / Withdraw】
MerchantLedger[merchant] -= amount (帳簿更新)
Protocol Pool → Merchant Wallet (実際の送金)
```

**Phase 2（将来）: CSPL 対応**

1. CSPL が利用可能になり次第、Deposit/Withdraw 時の金額も秘匿
2. 抽象化レイヤーを設計し、移行コストを最小化

### 10.2 Shared Pool パターンのセキュリティ考慮

| リスク                    | 対策                                |
| ------------------------- | ----------------------------------- |
| Pool 全体のスマコンリスク | 監査実施、段階的な TVL 上限設定     |
| 不正な帳簿操作            | Arcium MPC による暗号化、署名検証   |
| 流動性不足                | Pool 残高と帳簿合計の整合性チェック |

### 10.3 Arcium 依存

- Arcium MPC クラスターの可用性に依存
- フォールバック機構の検討が必要

## 11. ロードマップ概要

| Phase   | 内容                                   | 期間     |
| ------- | -------------------------------------- | -------- |
| Phase 1 | MVP（コアオンチェーン機能 + 基本 SDK） | 3 ヶ月   |
| Phase 2 | Dashboard + 高度な暗号化機能           | 2 ヶ月   |
| Phase 3 | CSPL 対応 + パフォーマンス最適化       | 3 ヶ月   |
| Phase 4 | マルチチェーン展開（Ethereum L2 等）   | 6 ヶ月〜 |

---

## 変更履歴

| 日付       | バージョン | 変更内容                                                | 作成者 |
| ---------- | ---------- | ------------------------------------------------------- | ------ |
| 2025-01-31 | 1.0        | 初版作成                                                | -      |
| 2025-01-31 | 1.1        | Shared Pool + Ledger パターンに変更、User Withdraw 追加 | -      |
| 2025-01-31 | 1.2        | Arcium 3フェーズパターン（Init/Queue/Callback）を反映   | -      |
